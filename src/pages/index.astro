---
import BaseLayout from "@/layouts/BaseLayout.astro";
import WeatherPanel from "@/dashboard/WeatherPanel.astro";
import EmptyPanel from "@/dashboard/EmptyPanel.astro";
import ErrorPanel from "@/dashboard/ErrorPanel.astro";

const lat = Astro.url.searchParams.get("lat");
const lon = Astro.url.searchParams.get("lon");

let weatherData: Record<string, any>;
let forecastData: Record<string, any>;

let isError = false;

try {
  if (lat && lon) {
    weatherData = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${
        import.meta.env.WEATHER_API_KEY
      }&units=metric`
    ).then((res) => {
      if (!res.ok) throw Error();
      return res.json();
    });

    forecastData = await fetch(
      `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${
        import.meta.env.WEATHER_API_KEY
      }&units=metric&cnt=6`
    ).then((res) => {
      if (!res.ok) throw Error();
      return res.json();
    });
  }
} catch {
  isError = true;
}
---

<BaseLayout>
  <EmptyPanel />
  {
    !isError ? (
      weatherData ? (
        <WeatherPanel {weatherData} {forecastData} />
      ) : (
        <EmptyPanel />
      )
    ) : (
      <ErrorPanel />
    )
  }
</BaseLayout>
