---
import CloseIcon from "@/icons/CloseIcon.astro";
import SearchIcon from "@/icons/SearchIcon.astro";
---

<script>
  import { alpineData } from "@/utils";

  alpineData("search_form", () => ({
    init() {
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "k") {
          e.preventDefault();
          this.$refs.dialog.showModal();
        }
      });
    },
    results: [
      {
        name: "London",
        lat: 51.5073219,
        lon: -0.1276474,
        country: "United Kingdom",
      },
      {
        name: "City of London",
        lat: 51.5156177,
        lon: -0.0919983,
        country: "United Kingdom",
      },
      { name: "London", lat: 42.9832406, lon: -81.243372, country: "Canada" },
      {
        name: "Chelsea",
        lat: 51.4875167,
        lon: -0.1687007,
        country: "United Kingdom",
      },
      {
        name: "London",
        lat: 37.1289771,
        lon: -84.0832646,
        country: "United States",
      },
    ],
    async fetchResults() {
      // TODO: handle error
      const res = await fetch("/api/cities?q=" + this.$refs.search.value).then(
        (res) => res.json()
      );
      this.results = res;
    },
  }));
</script>

<div x-data="search_form">
  <button
    class="py-2 flex items-center gap-3 px-2 md:pr-4 rounded-full bg-surface-300 border border-surface-500 dark:border-surface-800 dark:bg-surface-900"
    @click="$refs.dialog.showModal()"
  >
    <span class="w-5 text-surface-600">
      <SearchIcon />
    </span>
    <span class="hidden sm:block text-sm text-surface-600 dark:text-surface-400"
      >find city</span
    >
    <span
      class="hidden sm:block text-xs p-0.5 px-1.5 bg-surface-100 dark:bg-surface-800 opacity-40"
      >ctrl + k</span
    >
  </button>

  <dialog
    class="text-inherit bg-transparent mt-40 w-full max-w-96"
    x-ref="dialog"
  >
    <div
      class="p-4 pt-7 bg-surface-50 dark:bg-surface-900 rounded-md mx-2 relative"
    >
      <button
        class="bg-transparent absolute right-1 top-1 w-8 h-8"
        @click="$refs.dialog.close()"
      >
        <CloseIcon />
      </button>

      <form @submit.prevent="fetchResults()">
        <input
          class="border-b p-1 outline-none bg-transparent border-surface-400 dark:border-surface-800 w-full"
          x-ref="search"
          type="search"
          autofocus
        />
      </form>

      <ul class="pt-4">
        <template x-for="result in results">
          <li>
            <a
              class="flex gap-3 items-end text-auto p-1"
              :href="`/?lat=${result.lat}&lon=${result.lon}`"
            >
              <span x-text="result.name"></span>
              <span class="text-sm opacity-70" x-text="result.country"></span>
            </a>
          </li>
        </template>
      </ul>
    </div>
  </dialog>
</div>
